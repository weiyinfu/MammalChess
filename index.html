<html>
<head>
    <title>ä¸€è±¡äºŒç‹®</title>
    <meta charset="UTF-8">
    <link rel="icon" sizes="any" mask href="./lion.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <link rel="stylesheet/less" type="text/css" href="index.less"/>
    <script src="https://cdn.bootcss.com/less.js/3.10.3/less.min.js"></script>
    <script src="https://cdn.bootcss.com/vue/2.6.11/vue.js"></script>
    <script src="https://cdn.bootcss.com/axios/0.19.2/axios.min.js"></script>
    <script src="game.js"></script>
</head>
<body>
<div id="main">
    <div class="header">
        <!--é€‰æ‹©æ£‹å­æ ·å¼-->
        <select v-model="conf.animalMap" @change="saveConf">
            <option v-for="(v,k) in ANIMAL_MAP" :value="k">ä½¿ç”¨{{v.name}}</option>
        </select>
        <button @click="newGame">æ–°æ¸¸æˆ</button>
        <div>
            <span>é™éŸ³</span>
            <input v-model="conf.mute"
                   type="checkbox"
                   @change="saveConf"
                   style="width:100%;height:100%;">
        </div>
    </div>
    <!--æ£‹ç›˜åŒºåŸŸï¼Œ4Ã—4ä¸ªgrid-->
    <div class="body" ref="body">
        <div class="board" v-if="game">
            <div v-for="row in 4" style=" display: flex;">
                <div v-for="col in 4" class="grid" :style="gridStyle(get(row,col))" @click="choose(get(row,col))">
                    {{get(row,col)==lastMove.src?'ğŸ’¢':getAnimal(game.a[get(row,col)])}}
                </div>
            </div>
        </div>
        <!--æ¸¸æˆç»“æŸæ¶ˆæ¯æç¤ºé¢æ¿-->
        <div class="info" v-if="info">
            <div>{{info}}</div>
        </div>
        <!--AIæ­£åœ¨æ€è€ƒ-->
        <div class="thinking" :style="{fontSize:gridSize*0.6+'px'}" v-if="turn===1">ğŸµ</div>
    </div>
    <!--çŠ¶æ€æ -->
    <div class="footer" v-if="game">
        <div>
            <span>æ‚¨çš„å±€åŠ¿ï¼š</span> <span style="background-color: khaki;">{{randomChoose(aiScore<0?emotion.happy:emotion.sad)}}</span>&nbsp;
        </div>
        <div v-if="game.peaceClock>=game.PEACE_CLOCK*0.5">
            <div class="sep"></div>
            å’Œæ£‹å€’è®¡æ—¶ï¼š<span
                style="background-color: khaki">{{game.PEACE_CLOCK-game.peaceClock}}</span>
        </div>
        <div>
            <template v-if="lastMove.type==='eat'">
                <div class="sep"></div>
                <span :style="animalStyle(lastMove.srcChess)">{{getAnimal(lastMove.srcChess)}}</span>åƒäº†
                <span :style="animalStyle(lastMove.desChess)">{{getAnimal(lastMove.desChess)}}</span>
            </template>
            <template v-else-if="lastMove.type==='recover'">
                <div class="sep"></div>
                {{turn===0?'ç”µè„‘':'æ‚¨'}}ç¿»å‡ºäº†<span
                    :style="animalStyle(lastMove.srcChess)">{{getAnimal(lastMove.srcChess)}}</span>
            </template>
            <template v-else-if="lastMove.type==='move'">
                <div class="sep"></div>
                {{turn===0?'ç”µè„‘':'æ‚¨'}}ç§»åŠ¨äº†<span
                    :style="animalStyle(lastMove.srcChess)">{{getAnimal(lastMove.srcChess)}}</span>
            </template>
        </div>
    </div>
    <audio src="res/capture.wav" ref="capture" preload="auto"></audio><!--æœ‰æ£‹å­è¢«åƒæ‰-->
    <audio src="res/click.wav" ref="click" preload="auto"></audio><!--é€‰ä¸­æ£‹å­çš„å£°éŸ³-->
    <audio src="res/move.wav" ref="move" preload="auto"></audio><!--æ£‹å­ç§»åŠ¨éŸ³æ•ˆ-->
    <audio src="res/lose.wav" ref="lose" preload="auto"></audio> <!--ä½ è¾“äº†éŸ³æ•ˆ-->
    <audio src="res/win.wav" ref="win" preload="auto"></audio> <!--ä½ èµ¢äº†éŸ³æ•ˆ-->
    <audio src="res/draw.wav" ref="peace" preload="auto"></audio><!--å’Œæ£‹-->
    <audio src="res/start.wav" ref="start" preload="auto"></audio><!--æ¸¸æˆå¼€å§‹éŸ³æ•ˆ-->
    <audio src="res/illegal.wav" ref="illegal" preload="auto"></audio><!--é”™è¯¯æ“ä½œéŸ³æ•ˆ-->
</div>
</body>
<script>
    const ANIMAL_MAP = {
        // ç¼–ç è¯´æ˜ï¼š0-7ä¸ºçº¢æ£‹,8-15ä¸ºç»¿æ——ï¼Œ16è¡¨ç¤ºæœªç¿»ï¼Œ17è¡¨ç¤ºç©ºç™½
        chinese: {
            chars: ["è±¡", "ç‹®", "è±¹", "è™", "ç‹¼", "ç‹—", "çŒ«", "é¼ ", "è±¡", "ç‹®", "è±¹", "è™", "ç‹¼", "ç‹—", "çŒ«", "é¼ ", "+", " "],
            name: "æ±‰å­—"
        },
        hieroglyph: {
            chars: ["ğŸ˜", "ğŸ¦", "ğŸ†", "ğŸ…", "ğŸº", "ğŸ•", "ğŸˆ", "ğŸ€", "ğŸ˜", "ğŸ¦", "ğŸ†", "ğŸ…", "ğŸº", "ğŸ•", "ğŸˆ", "ğŸ€", "ğŸ•¸", ' '],
            name: "è±¡å½¢"
        },
        number: {
            chars: [1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, '+', ' '],
            name: "é˜¿æ‹‰ä¼¯æ•°å­—"
        },
        chineseNumber: {
            chars: ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', '+', ' '],
            name: "æ±‰è¯­æ•°å­—"
        }
    }
    //è¡¨æƒ…ï¼šç”¨äºè¡¨ç¤ºå±€é¢çš„å¥½å
    const emotion = {
        sad: ['ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ˜¢', 'ğŸ˜£', 'ğŸ˜¥'],
        happy: ['ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†']
    }
    //ç€æ³•ç±»å‹
    const MOVE_TYPE = {
        eat: 'eat',
        move: 'move',
        recover: 'recover'
    }
    //æ£‹å­é¢œè‰²
    const COLORS = {
        RED: '#ff8888',
        GREEN: '#88ff88'
    }
    //è½®æ¬¡ï¼Œè½®åˆ°ç”¨æˆ·èµ°åˆ™ä¸º0,è½®åˆ°è®¡ç®—æœºèµ°åˆ™ä¸º1
    const TURN = {
        USER: 0,
        COMPUTER: 1,
    }
    const main = {
        el: '#main',
        data() {
            return {
                //æ¸¸æˆçŠ¶æ€ç›¸å…³
                game: null,
                turn: 0,//è½®åˆ°è°èµ°æ£‹ï¼Œ0è¡¨ç¤ºç”¨æˆ·ï¼Œ1è¡¨ç¤ºç”µè„‘
                //UIç›¸å…³
                gridSize: 0,//æ¯ä¸ªgridçš„å¤§å°
                ANIMAL_MAP,//åŠ¨ç‰©æ˜ å°„
                chosen: -1,//ç”¨æˆ·é€‰ä¸­çš„æ£‹å­
                userColor: -1,//ç”¨æˆ·ä½¿ç”¨çš„èŠ±è‰²ï¼Œç¬¬ä¸€æ¬¡ç¿»åˆ°ä»€ä¹ˆé¢œè‰²å°±ç”¨ä»€ä¹ˆé¢œè‰²
                //æœ€åä¸€æ¬¡ç§»åŠ¨çš„æ£‹å­
                lastMove: {
                    type: null,//ä¸Šä¸€ä¸ªæ“ä½œçš„ç±»å‹ï¼Œå–å€¼ä¸ºMOVE_TYPEä¸­çš„å†…å®¹
                    src: -1,//åˆšåˆšç§»åŠ¨çš„æ£‹å­çš„ä½ç½®
                    des: -1,//åˆšåˆšæ­»äº¡çš„æ£‹å­çš„ä½ç½®
                    desChess: null,//åˆšåˆšæ­»äº¡çš„æ£‹å­
                    srcChess: null,//åˆšåˆšç§»åŠ¨çš„æ£‹å­
                },
                info: '',//ä¿¡æ¯æ¡†çš„å†…å®¹
                //AIç›¸å…³
                ai: new Worker("ai.js"),
                emotion,//è¡¨æƒ…ç¬¦å·å¸¸é‡åˆ—è¡¨
                aiScore: 0,//aiåˆ¤æ–­å‡ºåˆ†æ•°
                aiConfig: {
                    maxDepth: 8
                },
                //ç•Œé¢è®¾ç½®
                conf: {
                    mute: false,//æ˜¯å¦é™éŸ³
                    minAiTime: 1000,//AIæ€è€ƒçš„æœ€å°‘æ—¶é—´ï¼Œå¦‚æœAIæ€è€ƒæ—¶é—´ä¸è¶³æ­¤æ—¶é—´ï¼Œå°±ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œ
                    animalMap: "hieroglyph",//ç”¨å“ªå¥—å­—ç¬¦æ˜¾ç¤ºåŠ¨ç‰©
                }
            }
        },
        mounted() {
            this.loadConf()
            window.onresize = this.updateGridSize
            this.updateGridSize()
            this.newGame()
            this.ai.onerror = (e) => {
                console.log('AI error :')
                console.log(e)
            }
        },
        methods: {
            loadConf() {
                //åŠ è½½é…ç½®
                if (localStorage.conf)
                    try {
                        var conf = JSON.parse(localStorage.conf)
                        for (var i in this.conf) {
                            if (conf.hasOwnProperty(i)) {
                                this.conf[i] = conf[i]
                            }
                        }
                    } catch (e) {
                        //åŠ è½½é…ç½®å‡ºé”™äº†ï¼Œæ¸…ç©ºé…ç½®
                        console.log('load config error')
                        localStorage.conf = null
                    }
            },
            saveConf() {
                //ä¿å­˜é…ç½®
                localStorage.conf = JSON.stringify(this.conf)
            },
            randomChoose(a) {
                return a[Math.floor(Math.random() * a.length)]
            },
            playSound(soundName) {
                if (!this.conf.mute)
                    this.$refs[soundName].play()
            },
            updateGridSize() {
                //æ ¹æ®çª—å£å¤§å°è‡ªåŠ¨è°ƒæ•´æ¯ä¸ªæ ¼å­çš„å¤§å°
                const rect = this.$refs.body.getBoundingClientRect()
                const size = Math.min(rect.width, rect.height) - 20
                this.gridSize = Math.floor(size / 4)
            },
            eat(src, des) {
                //srcå¤„çš„æ£‹å­åƒæ‰deså¤„çš„æ£‹å­
                var eaten = this.game.a[des]
                if (eaten !== 17)//å¦‚æœç›®æ ‡å¤„æœ‰æ£‹å­ï¼Œé‚£ä¹ˆå°±è¦åƒæ‰å®ƒ
                {
                    this.lastMove.type = MOVE_TYPE.eat
                    this.lastMove.src = src
                    this.lastMove.des = des
                    this.lastMove.desChess = eaten
                    this.lastMove.srcChess = this.game.a[src]
                    this.playSound('capture')
                } else {
                    //ç›®æ ‡å¤„æ²¡æœ‰æ£‹å­ï¼Œèµ°å¾—æ˜¯ç©ºæ­¥
                    this.lastMove.type = MOVE_TYPE.move
                    this.lastMove.src = src
                    this.lastMove.des = des
                    this.lastMove.srcChess = this.game.a[src]
                    this.lastMove.desChess = null
                    this.playSound('move')
                }
                this.chosen = -1
                this.game.eat(src, des)
                //eatå‘ç”Ÿåï¼Œæ•°ç»„aå·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œä½†æ˜¯è¦æƒ³è®©UIå‘ç”Ÿæ”¹å˜ï¼Œæ­¤å¤„åº”è¯¥ä½¿ç”¨$set
                this.$set(this.game.a, des, this.game.a[des])
                this.$set(this.game.a, src, this.game.a[src])
            },
            recover(ind) {
                //ç¿»å¼€indå¤„çš„æ£‹å­
                this.game.recover(ind)
                this.$set(this.game.a, ind, this.game.a[ind])
                const chessId = this.game.a[ind]
                if (this.game.unknown.length === 15) {
                    //å¦‚æœæœªçŸ¥å…ƒç´ ä¸º15ä¸ªï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªç¿»å‡ºæ¥çš„é¢œè‰²å°±å¯ä»¥å†³å®šç”¨æˆ·çš„èŠ±è‰²
                    this.userColor = chessId < 8 ? 0 : 1
                }
                this.chosen = -1
                this.lastMove.src = -1
                this.lastMove.desChess = null
                this.lastMove.des = ind
                this.lastMove.srcChess = chessId
                this.lastMove.type = MOVE_TYPE.recover
            },
            illegal() {
                //éæ³•æ“ä½œduangçš„ä¸€å£°
                this.playSound('illegal')
            },
            choose(ind) {
                //ç”¨æˆ·ç‚¹å‡»äº†indå¤„çš„æ£‹å­
                //å¦‚æœä¸è¯¥ç€ç”¨æˆ·èµ°ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›
                if (this.turn === TURN.COMPUTER) return
                if (this.game.a[ind] === 16) {//å¦‚æœæ˜¯æœªçŸ¥å…ƒç´ ï¼Œç”¨æˆ·ç¿»æ–°ç‰Œ
                    if (this.game.canRecover(ind)) {
                        this.recover(ind)
                    } else {
                        this.illegal()
                        return
                    }
                } else if (this.game.a[ind] === 17) {
                    //å¦‚æœæ˜¯ç©ºç™½ï¼Œé‚£ä¹ˆç§»åŠ¨æ£‹å­
                    if (this.chosen === -1) return//å¦‚æœæ²¡æœ‰é€‰æ‹©ç›´æ¥ç‚¹å‡»ç©ºç™½å¤„
                    if (!this.game.isNeibor(this.chosen, ind)) {
                        //ä¸åˆæ³•çš„ç§»åŠ¨
                        this.illegal()
                        return
                    }
                    this.eat(this.chosen, ind)
                } else {
                    //å¦‚æœç‚¹å‡»æ£‹å­
                    if (this.chosen === -1) {
                        //å¦‚æœæœªé€‰ä¸­æ£‹å­ï¼Œåˆ™è¡¨ç¤ºç¬¬ä¸€æ¬¡é€‰ä¸­æ£‹å­
                        const srcColor = this.game.a[ind] < 8 ? 0 : 1
                        if (srcColor === this.userColor) {
                            //ç”¨æˆ·åªèƒ½æ§åˆ¶è·Ÿå®ƒä¸€æ ·èŠ±è‰²çš„æ£‹å­
                            this.chosen = ind
                            this.playSound('click')
                        }
                        return
                    }
                    //å¦‚æœå·²ç»é€‰ä¸­æ£‹å­
                    var srcColor = this.game.a[this.chosen] < 8
                    var desColor = this.game.a[ind] < 8
                    if (srcColor === desColor) {
                        //é¢œè‰²ç›¸åŒï¼Œæ”¹å˜é€‰æ‹©çš„æ£‹å­
                        this.chosen = ind
                        this.playSound('click')
                        return
                    }
                    //é¢œè‰²ä¸åŒï¼Œåƒæ‰å¯¹æ–¹çš„æ£‹å­
                    if (this.game.canEat(this.chosen, ind)) {
                        //å¦‚æœèƒ½åƒ
                        this.eat(this.chosen, ind)
                    } else {
                        this.illegal()
                        return
                    }
                }
                if (this.isOver()) {
                    this.over()
                    return
                }
                this.turn = TURN.COMPUTER //è½®åˆ°è®¡ç®—æœºäº†
                this.computer()
            },
            computer() {
                //ç”¨è¿™ä¸ªéšæœºæ•°ä½œä¸ºæ­¤æ¬¡è¯·æ±‚çš„æ ‡å¿—
                const randomKey = Math.floor(Math.random() * 1e9)
                const thinkBeginTime = new Date().getTime()
                const aiCallback = (ans) => {
                    if (this.turn === TURN.USER) throw 'ä¸è¯¥ç€AIä¸‹å‘¢'
                    const op = ans.strategy
                    this.aiScore = ans.score
                    if (op === null) {
                        //å¦‚æœAIæ²¡æœ‰ä½œå‡ºå†³ç­–ï¼Œé‚£ä¹ˆAIè®¤è¾“
                        this.over()
                        return
                    }
                    if (op.length === 2) {
                        var [src, des] = op
                        var srcColor = this.game.a[src] < 8 ? 0 : 1
                        if (srcColor === this.userColor) {
                            throw 'computer color error'
                        }
                        //å¦‚æœæ˜¯æ£‹å­
                        if (!this.game.canEat(src, des)) {
                            throw 'AIè¿”å›çš„æ“ä½œä¸åˆç†ï¼šä¸èƒ½åƒ'
                        }
                        this.eat(src, des)
                    } else if (op.length === 1) {
                        if (!this.game.canRecover(op[0])) throw "cannot recover " + op[0]
                        this.recover(op[0])
                    } else {
                        throw 'AIè¿”å›çš„æ“ä½œæ— æ³•è¯†åˆ«'
                    }
                    if (this.isOver()) {
                        this.over()
                    }
                    this.turn = TURN.USER//è½®åˆ°äººèµ°äº†
                }
                this.ai.onmessage = (event) => {
                    if (event.data.id !== randomKey) {
                        console.log('got unexpected randomKey')
                        return
                    }
                    //æ”¶åˆ°AIå‘å›çš„æ¶ˆæ¯
                    //å¦‚æœè½®åˆ°ç”¨æˆ·ä¸‹æ£‹ï¼Œå¿½ç•¥AIçš„æ¶ˆæ¯
                    console.log('AI reply')
                    console.log(event.data)
                    const now = new Date().getTime()
                    if (now - thinkBeginTime < this.conf.minAiTime) {
                        setTimeout(() => aiCallback(event.data), this.conf.minAiTime - (now - thinkBeginTime))
                    } else {
                        aiCallback(event.data)
                    }
                }
                const smallChessCount = this.game.a.reduce((s, x) => s + (x < 8 ? 1 : 0), 0),
                    bigChessCount = this.game.a.reduce((s, x) => (x >= 8 && x < 16 ? 1 : 0), 0)
                //åŠ¨æ€maxDepthï¼Œä¸ç„¶æœç´¢æ—¶é—´å¤ªé•¿
                let maxDepth = this.aiConfig.maxDepth
                if (this.game.unknown.length > 8) {
                    maxDepth = Math.min(maxDepth, 5)
                }
                if (this.game.unknown.length === 0) {
                    //å¦‚æœå·²ç»æ²¡æœ‰ä¸çŸ¥é“çš„ç‰Œäº†
                    if (Math.min(smallChessCount, bigChessCount) < 3) {
                        //è¿›å…¥æ®‹å±€é˜¶æ®µï¼Œæœç´¢æ·±åº¦åŠ æ·±
                        maxDepth += 2
                    }
                }
                this.ai.postMessage({
                    a: this.game.a,
                    unknown: this.game.unknown,
                    computerColor: 1 - this.userColor,
                    maxDepth,
                    id: randomKey,
                })
            },
            isOver() {
                return this.game.getState() !== Game.UNSURE
            },
            over() {
                //æ¸¸æˆç»“æŸ
                const gameState = this.game.getState();
                if (gameState === Game.PEACE) {
                    this.info = 'å’Œæ£‹ï¼'
                    this.playSound('peace')
                } else {
                    if (gameState === Game.UNSURE) {
                        throw "shouldn't call over() because gameState is unsure"
                    }
                    const winColor = gameState === Game.FIRST_WIN ? 0 : 1
                    if (this.userColor === winColor) {
                        //è½®åˆ°ç”¨æˆ·èµ°æ£‹
                        this.info = 'æ‚¨èµ¢äº†'
                        this.playSound('win')
                    } else {
                        this.info = 'æ‚¨è¾“äº†'
                        this.playSound('lose')
                    }
                }
            },
            get(row, col) {
                return (row - 1) * 4 + col - 1
            },
            getAnimal(ind) {
                if (!(ind >= 0 && ind <= 17)) throw 'getAnimal got error index: ind=' + ind
                return this.ANIMAL_MAP[this.conf.animalMap].chars[ind]
            },
            newGame() {
                //æ–°æ¸¸æˆ
                this.game = Game.newGame()
                this.turn = 0
                this.userColor = 0
                this.chosen = -1
                this.lastMove = {src: -1, des: -1, srcChess: null, desChess: null, type: null}
                this.playSound('start')
                this.info = ''
            },
            animalStyle(chess) {
                return {
                    background: chess < 8 ? COLORS.RED : COLORS.GREEN
                }
            },
            gridStyle(id) {
                //ä¸åŒçš„æ ¼å­è·Ÿæ®æ£‹å­çš„ä¸åŒæ˜¾ç¤ºä¸åŒ
                const style = {}
                const chess = this.game.a[id]
                if (chess < 8) {
                    style.backgroundColor = COLORS.RED
                } else if (chess < 16) {
                    style.backgroundColor = COLORS.GREEN
                }
                Object.assign(style, {
                    width: this.gridSize + 'px',
                    height: this.gridSize + 'px',
                    fontSize: this.gridSize * 0.8 + "px"
                })
                if (this.chosen === id) {
                    style.borderWidth = '5px'
                }
                if (this.lastMove.des === id) {
                    style.animation = 'turn 4s linear infinite'
                }
                if (this.lastMove.src === id) {
                    style.color = 'grey'
                    style.opacity = 0.3
                }
                return style
            },
        }
    }
    var haha = null
    document.onreadystatechange = () => {
        if (document.readyState !== 'complete') return
        main.el = "#main"
        haha = new Vue(main)
    }
</script>
</html>
